{% load staticfiles %}
{% load i18n %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>School CTF Spring 2015</title>
    <link rel="stylesheet" href="{% static "css/bootstrap.min.css" %}"/>
    <link rel="stylesheet" href="{% static "css/bootstrap-theme.min.css" %}"/>
    <link rel="stylesheet" href="{% static "css/common.css" %}"/>
    <link rel="stylesheet" href="{% static "css/menu.css" %}"/>
    <script src="{% static "js/jquery-2.1.3.min.js" %}"></script>
    <script src="{% static "js/bootstrap.min.js" %}"></script>
    <script src="{% static "js/velocity.min.js" %}"></script>
    <script src="{% static "js/velocity.ui.min.js" %}"></script>
    <script src="{% static "js/forms.js" %}"></script>
    <script src="{% static "js/monads.js" %}"></script>
    <script src="{% static "js/animation.js" %}"></script>
    <script src="{% static "js/teams.js" %}"></script>
  </head>
  <body>
    <div class="menu">
      <div class="container">
        <div class="row">
          <div class="col-xs-12 col-md-12">
            <div class="menu-button active" data-target="#home">
              <span class="visible-md-inline visible-lg-inline">{% trans "Home" context "menu bar" %}</span>
              <span class="glyphicon glyphicon-home visible-xs-inline visible-sm-inline"></span>
            </div>
            <div class="menu-button" data-target="#reg">
              <span class="visible-md-inline visible-lg-inline">{% trans "Registration" %}</span>
              <span class="glyphicon glyphicon-user visible-xs-inline visible-sm-inline"></span>
            </div>
            <div class="menu-button" data-target="#teams">
              <span class="visible-md-inline visible-lg-inline">{% trans "Teams" %}</span>
              <span class="glyphicon glyphicon-list visible-xs-inline visible-sm-inline"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="menu-after"></div>
    <div class="copyright">
      &copy; 2010&ndash;2015, <a href="http://sibears.ru">SiBears</a>
    </div>
    <div class="viewpoint">

      <div id="home" class="screenful">
        <div class="container">
          <div class="row">
            <div class="col-md-5">
              <h3 class="in1-fade">{% trans "What is School CTF?" %}</h3>
              <p class="in1-fade">{% trans "The computer security competition for school pupils School CTF is hosted by the SiBears team annually since 2010." %}</p>
              <p class="in1-fade">{% trans "School CTF traditionally takes place in autumn, but in 2014 School CTF was postponed to the spring semester." %}</p>
              <p class="in1-fade">{% blocktrans %}School CTF Spring 2015 takes place at May 3rd, 2015. It starts at 12:00 p.m., Tomsk time (GMT+6), and ends at 5:00 p.m., Tomsk time (GMT+6). You may <a href="https://www.google.com/calendar/event?eid=YTdpOTlqbnZ1cGZqZDFpZ2RzYWNpbGV2MW8gbTRxczJsNDBtNjI3ODhxdnNwMmg2NXBtaHNAZw&ctz=Asia/Novosibirsk">add the event</a> to your Google calendar not to forget it.{% endblocktrans %}</p>
              <h3 class="in2-fade">{% trans "Is School CTF just for school pupils?" %}</h3>
              <p class="in2-fade">{% trans "Any team is welcome, not just that comprised of school pupils. The ratings are calculated separately for school teams and for all teams." %}</p>
              <h3 class="in3-fade">{% trans "What do I need to participate?" %}</h3>
              <p class="in3-fade">{% trans "A team of one to seven persons, internet access and five hours of spare time." %}</p>
            </div>
            <div class="col-md-5 col-md-offset-1">
              <div class="in4-fade">
                <img class="visible-xs-inline" src="{% static "img/bear-xs.png" %}"/>
                <img class="visible-sm-inline" src="{% static "img/bear-sm.png" %}"/>
                <img class="visible-md-inline" src="{% static "img/bear-md.png" %}"/>
                <img class="visible-lg-inline" src="{% static "img/bear-lg.png" %}"/>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="reg" class="screenful">
        <div class="container">
          <div class="row">
            <div class="col-md-5">

              <div role="tabpanel" class="in1-fade in9-bounce">

                <ul class="nav nav-tabs" role="tablist">
                  <li role="presentation" class="active">
                    <a href="#teamRegForm" aria-controls="teamRegForm" role="tab" data-toggle="tab">{% trans "Team" %}</a>
                  </li>
                  <li role="presentation">
                    <a href="#participantRegForm" aria-controls="participantRegForm" role="tab" data-toggle="tab">{% trans "Participant" %}</a>
                  </li>
                </ul>

                <div class="well">
                  <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="teamRegForm">

                      <form id="regTeamForm" role="form">
                        <div class="form-group">
                          <input name="name" type="text" class="form-control" placeholder="{% trans "Team Name" %}"/>
                        </div>
                        <div class="checkbox">
                          <label>
                            <input name="is_school" type="checkbox"/> {% trans "Participants are school pupils" %}
                          </label>
                        </div>
                        <div class="form-group">
                          <select name="country" class="form-control">
                            <option disabled selected>{% trans "Country" %}<option>
                            <option value="">{% trans "I don't want to provide this information" %}</option>
                            {% for code, name in countries %}
                            <option value="{{ code }}">{{ name }}</option>
                            {% endfor %}
                          </select>
                        </div>
                        <div class="form-group">
                          <input name="school_name" type="text" class="form-control" placeholder="{% trans "School Name" %}"/>
                        </div>
                        <div class="form-group">
                          <input name="teacher_name" type="text" class="form-control" placeholder="{% trans "Teacher Name" %}"/>
                        </div>
                        <div class="form-group">
                          <input name="teacher_email" type="email" class="form-control" placeholder="{% trans "Teacher's E-Mail" %}"/>
                        </div>
                        <div class="form-group">
                          <input name="leader_email" type="email" class="form-control" placeholder="{% trans "Team Leader's E-Mail" %}"/>
                        </div>
                        <div class="form-group">
                          <textarea name="address" class="form-control" rows="3" placeholder="{% trans "Physical Mail Address for Certificates" %}"></textarea>
                        </div>
                        <button id="regTeamSubmitBtn" type="submit" class="btn btn-primary btn-lg">{% trans "Register Team" %}</button>
                      </form>
                      <div id="afterTeamRegMsg" class="in0-fade overlapping">
                        <p>{% trans "You've successfully registered a team. An authentication string has been sent to the team leader's email and the teacher's email (if any). You should pass this string to the participants you want to register as your team members. Note that team leader should also register as a team member." %}
                      </div>

                    </div>
                    <div role="tabpanel" class="tab-pane" id="participantRegForm">

                      <form id="regParticipantForm" role="form">
                        <div class="form-group">
                          <input name="username" type="text" class="form-control" placeholder="{% trans "Login" %}"/>
                        </div>
                        <div class="form-group">
                          <input name="password1" type="password" class="form-control" placeholder="{% trans "Password" %}"/>
                        </div>
                        <div class="form-group">
                          <input name="password2" type="password" class="form-control" placeholder="{% trans "Password Again" %}"/>
                        </div>
                        <div class="form-group">
                          <input name="first_name" type="text" class="form-control" placeholder="{% trans "Full Name" %}"/>
                        </div>
                        <div class="form-group">
                          <input name="team" type="text" class="form-control" placeholder="{% trans "Authentication String" %}"/>
                        </div>
                        <button id="regParticipantSubmitBtn" type="submit" class="btn btn-primary btn-lg">{% trans "Register Participant" %}</button>
                      </form>
                      <div id="afterParticipantRegMsg" class="in0-fade overlapping">
                        <p>{% trans "You are successfully registered as a School CTF Spring 2015 participant! Your team leader and teacher (if any) have been notified. Please, don't forget your password. See you later at the competition." %}
                      </div>

                    </div>
                  </div>
                </div>

              </div>

            </div>

            <div class="col-md-5 col-md-offset-1">
              <div class="in2-fade">
                <img class="visible-xs-inline" src="{% static "img/bear-reg-xs.png" %}"/>
                <img class="visible-sm-inline" src="{% static "img/bear-reg-sm.png" %}"/>
                <img class="visible-md-inline" src="{% static "img/bear-reg-md.png" %}"/>
                <img class="visible-lg-inline" src="{% static "img/bear-reg-lg.png" %}"/>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="teams" class="screenful">
        <div class="container">
          <div class="row">

            <div class="col-md-5">
              <h3 class="in1-fade">{% trans "School Teams" context "teams list" %}</h3>
              <table id="school-teams" class="table table-condensed in1-fade">
                <thead>
                  <tr>
                    <th>{% trans "Name" context "teams list" %}</th>
                    <th>{% trans "Country" context "teams list" %}</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>

            <div class="col-md-5 col-md-offset-1">
              <h3 class="in2-fade">{% trans "Non-School Teams" context "teams list" %}</h3>
              <table id="non-school-teams" class="table table-condensed in2-fade">
                <thead>
                  <tr>
                    <th>{% trans "Name" context "teams list"  %}</th>
                    <th>{% trans "Country" context "teams list" %}</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>

      <div id="teams">
        <div class="container">
          <div class="row">
            <div class="col-md-5">
            </div>
            <div class="col-md-5 col-md-offset-1">
            </div>
          </div>
        </div>
      </div>

    </div>
    <script>
    $(document).ready(function () {
        var animation = new SlrAnimation('#home');
        animation.animateIn($('#home'));
        animation.putGeo('#reg', -1, 0);
        $('#reg').css({left: $(window).width(), top: 0});
        animation.putGeo('#teams', -2, 0);
        $('#teams').css({left: $(window).width() * 2, top: 0});

        $('.menu-button').click(function () {
          var target = $(this).data('target');
          animation.moveTo(target).then(function () {
            for (var i = 1; i <= 9; ++i) {
              $(target).find('.in'+i+'-fade').removeClass('in'+i+'-fade');
            }
          });
          $('.menu-button').removeClass('active');
          $(this).addClass('active');
        });


        var regTeamForm = new Form('#regTeamForm');

        $('#regTeamSubmitBtn').click(function (e) {
          e.preventDefault();
          $.ajax({
            method: 'POST',
            url: '{% url "teams" %}',
            dataType: 'json',
            data: regTeamForm.getJson(),
            success: function () {
              regTeamForm.hideErrors();
              animation.fadeElementOut('#regTeamForm').then(function () {
                $('#afterTeamRegMsg').css('display', 'inline-block');
                animation.fadeElementIn('#afterTeamRegMsg');
              });
            },
            error: function (xhr, stat, err) {
              regTeamForm.showErrors(JSON.parse(xhr.responseText));
            }
          });
        });


        var regParticipantForm = new Form('#regParticipantForm');
        regParticipantForm.getJson = function () {
          var json = Form.prototype.getJson.call(this);
          json['user'] = {};
          ['username', 'password1', 'password2', 'first_name'].forEach(
              function (fieldName) {
                if (fieldName in json) {
                  json['user'][fieldName] = json[fieldName];
                  delete json[fieldName];
                }
              }
          );
          return json;
        };

        $('#regParticipantSubmitBtn').click(function (e) {
          e.preventDefault();
          $.ajax({
            method: 'POST',
            url: '{% url "members" %}',
            dataType: 'json',
            contentType: 'application/json',
            data: regParticipantForm.getJsonString(),
            success: function () {
              regParticipantForm.hideErrors();
              animation.fadeElementOut('#regParticipantForm').then(function () {
                $('#afterParticipantRegMsg').css('display', 'inline-block');
                animation.fadeElementIn('#afterParticipantRegMsg');
              });
            },
            error: function (xhr, stat, err) {
              var errObj = JSON.parse(xhr.responseText);
              var userObj = errObj['user'];
              delete errObj['user'];
              for (var key in userObj) {
                errObj[key] = userObj[key];
              }
              regParticipantForm.showErrors(errObj);
            },
          });
        });

        $.ajax({
          method: 'GET',
          url: '{% url "teams" %}',
          dataType: 'json',
          contentType: 'application/json',
          success: function (data, stat, xhr) {
            var teams = JSON.parse(xhr.responseText);
            teams.sort(function (a, b) { return a.created_at - b.created_at; });
            var schoolTeams = new Array();
            var nonSchoolTeams = new Array();
            teams.forEach(function (team) {
              if (team.is_school) {
                schoolTeams.push(team);
              } else {
                nonSchoolTeams.push(team);
              }
            });
            populateTable($('#school-teams').find('tbody'), schoolTeams);
            populateTable($('#non-school-teams').find('tbody'), nonSchoolTeams);
          },
          error: function () { console.log('fail'); },
        });
    });
    </script>
  </body>
</html>
